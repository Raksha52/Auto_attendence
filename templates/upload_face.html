<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload Face - {{ student.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7f7f9}
    .card{max-width:720px;margin:2rem auto;padding:1rem}
    video{width:100%;height:auto;border-radius:8px;background:#000}
    canvas{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h5>Upload face for: {{ student.name }}</h5>
    <p>Existing captures: <strong id="count">{{ count }}</strong></p>
    <div class="mb-3">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <div>
      <button id="capture" class="btn btn-primary">Capture & Save</button>
      <a href="{{ url_for('student_dashboard') }}" class="btn btn-link">Back to Dashboard</a>
    </div>
    <div id="msg" class="mt-3"></div>
  </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const capture = document.getElementById('capture');
const msg = document.getElementById('msg');
const countEl = document.getElementById('count');

// ask for camera
navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
  video.srcObject = stream;
}).catch(err => {
  msg.innerText = 'Could not access camera: ' + err.message;
});

capture.addEventListener('click', async () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

  msg.innerText = 'Saving...';
  try {
    const res = await fetch(window.location.href, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ image: dataUrl })
    });
    const j = await res.json();
    if (j.success) {
      msg.innerText = 'Saved â€” total captures: ' + j.count;
      countEl.innerText = j.count;
    } else {
      msg.innerText = 'Error: ' + (j.message || 'unknown');
    }
  } catch (e) {
    msg.innerText = 'Error: ' + e.message;
  }
});
</script>
</body>
</html>